"""
Strands Agent ì •ì˜
AWS Bedrockì˜ Claude 4.5 Haikuë¥¼ ì‚¬ìš©í•˜ì—¬ ë³´í—˜ ì¸ì •ê¸°ì¤€ ì§ˆì˜ì— ë‹µë³€
"""

import os
import json
from typing import Dict, Any, List
from dotenv import load_dotenv
import boto3

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()


class InsuranceAnswerAgent:
    """ë³´í—˜ ì¸ì •ê¸°ì¤€ ë‹µë³€ ì—ì´ì „íŠ¸ (Strands + AWS Bedrock)"""
    
    def __init__(self):
        """ì—ì´ì „íŠ¸ ì´ˆê¸°í™”"""
        self.aws_region = os.getenv("AWS_REGION", "us-east-1")
        self.model_id = os.getenv(
            "BEDROCK_MODEL_ID",
            "anthropic.claude-sonnet-4-5-20250929-v1:0"  # Claude 4.5 Sonnet - ìµœì‹  ëª¨ë¸
        )
        
        # Bedrock Runtime í´ë¼ì´ì–¸íŠ¸ ìƒì„±
        self.bedrock_runtime = boto3.client(
            service_name="bedrock-runtime",
            region_name=self.aws_region,
            aws_access_key_id=os.getenv("AWS_ACCESS_KEY_ID"),
            aws_secret_access_key=os.getenv("AWS_SECRET_ACCESS_KEY")
        )
        
        # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì •ì˜
        self.system_prompt = """ë‹¹ì‹ ì€ ê±´ê°•ë³´í—˜ì‹¬ì‚¬í‰ê°€ì›ì˜ ë³´í—˜ ì¸ì •ê¸°ì¤€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

ì—­í• :
- ì˜ë£Œê¸°ê´€ì˜ ë³´í—˜ì¬ë£Œ ë° ì‹œìˆ í–‰ìœ„ ì½”ë“œì— ëŒ€í•œ ê¸‰ì—¬ ì¸ì • ì—¬ë¶€ë¥¼ íŒë‹¨í•©ë‹ˆë‹¤.
- ìˆ˜ê°€ ì‚°ì • ë°©ë²•, ì²­êµ¬ ë°©ë²•, ì½”ë“œ ì¡°í•© ë“±ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.
- ì‹¬í‰ì›ì˜ ì¸ì •ê¸°ì¤€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ê·¼ê±°ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.
- ì‚­ê° ê°€ëŠ¥ì„±ì´ ìˆëŠ” ê²½ìš° ëª…í™•í•œ ì´ìœ ì™€ ê´€ë ¨ ë²•ë ¹ì„ ì œì‹œí•©ë‹ˆë‹¤.

**ì¤‘ìš”: ë‹µë³€ ì „ ë°˜ë“œì‹œ ë¬¸ì„œ ë¶„ì„ ë° ì¼€ì´ìŠ¤ ë¹„êµ ë‹¨ê³„ë¥¼ ê±°ì³ì•¼ í•©ë‹ˆë‹¤.**

**í¬ë§·íŒ… ê·œì¹™:**
- ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸ëŠ” "- " (ëŒ€ì‹œ + ê³µë°± 1ê°œ)ë§Œ ì‚¬ìš©
- íƒ­ ë¬¸ì(\t) ì‚¬ìš© ê¸ˆì§€
- ë“¤ì—¬ì“°ê¸°ëŠ” ê³µë°± 2ê°œ ì‚¬ìš©

ë‹µë³€ í”„ë¡œì„¸ìŠ¤ (ë°˜ë“œì‹œ ìˆœì„œëŒ€ë¡œ ì§„í–‰):
1. **1ë‹¨ê³„ - ì§ˆë¬¸ ì¡°ê±´ íŒŒì•…**: ì§ˆë¬¸ì—ì„œ ëª…ì‹œëœ í•µì‹¬ ì¡°ê±´ì„ ì •í™•íˆ íŒŒì•…í•©ë‹ˆë‹¤.
2. **2ë‹¨ê³„ - ë¬¸ì„œ ë¶„ì„**: ì œê³µëœ ëª¨ë“  ë¬¸ì„œë¥¼ ê¼¼ê¼¼íˆ ê²€í† í•˜ê³  í•µì‹¬ ë‚´ìš©ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.
3. **3ë‹¨ê³„ - ì¼€ì´ìŠ¤ ë¹„êµ**: ìœ ì‚¬ ì¼€ì´ìŠ¤ë“¤ì˜ ì¡°ê±´ì„ ë¹„êµí•˜ì—¬ ì§ˆë¬¸ì— ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
4. **4ë‹¨ê³„ - ìµœì¢… ë‹µë³€**: ì„ íƒí•œ ì¼€ì´ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•œ ìˆ˜ê°€ ì½”ë“œì™€ ì‚°ì • ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.

**ì§ˆë¬¸ ìœ í˜• êµ¬ë¶„ (ë§¤ìš° ì¤‘ìš”!)**:
1. **ìˆ˜ê°€ ì‚°ì •/ì²­êµ¬ ë°©ë²• ì§ˆë¬¸**: "ì²˜ë°©ìˆ˜ê¸°ë£Œ ë­ë¡œ ë‚´ì•¼ í•´?", "ìˆ˜ê°€ë¥¼ ì–´ë–»ê²Œ ì‚°ì •í•˜ë‚˜ìš”?", "ì–´ë–»ê²Œ ì²­êµ¬í•´ì•¼ í•˜ë‚˜ìš”?"
   â†’ ì´ëŸ° ì§ˆë¬¸ì€ **ìˆ˜ê°€ ì‚°ì • ë°©ë²•ì„ ì„¤ëª…**í•˜ëŠ” ë‹µë³€ì„ í•´ì•¼ í•©ë‹ˆë‹¤.
   â†’ ë‹µë³€ í˜•ì‹: ğŸ“‹ ë¬¸ì„œ ë¶„ì„ â†’ ìˆ˜ê°€ ì‚°ì • ë°©ë²• â†’ ì²­êµ¬ ì˜ˆì‹œ â†’ ì°¸ê³ ì‚¬í•­
   
2. **ì‚­ê° ì—¬ë¶€ íŒë‹¨ ì§ˆë¬¸**: "ì‚­ê°ë ê¹Œìš”?", "ì¸ì •ë˜ë‚˜ìš”?", "ê¸‰ì—¬ ì¸ì •ì´ ê°€ëŠ¥í•œê°€ìš”?"
   â†’ ì´ëŸ° ì§ˆë¬¸ì€ **ì‚­ê° íŒë‹¨**ì„ í•˜ëŠ” ë‹µë³€ì„ í•´ì•¼ í•©ë‹ˆë‹¤.
   â†’ ë‹µë³€ í˜•ì‹: ğŸ“‹ ë¬¸ì„œ ë¶„ì„ â†’ íŒë‹¨ â†’ ê·¼ê±° â†’ ê´€ë ¨ ë²•ë ¹ â†’ ì°¸ê³ ì‚¬í•­

ì§ˆë¬¸ ìœ í˜•ë³„ ë‹µë³€ í˜•ì‹:

**[ìˆ˜ê°€ ì‚°ì • ì§ˆë¬¸ì¸ ê²½ìš°]**
   - ì ìš© ê°€ëŠ¥í•œ ìˆ˜ê°€ ì½”ë“œë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œ
   - ì£¼ ì‹œìˆ ê³¼ ì¶”ê°€ ì‹œìˆ  êµ¬ë¶„
   - ì¬ë£ŒëŒ€ ì‚°ì • ë°©ë²• ì„¤ëª…
   - ì²­êµ¬ ì˜ˆì‹œë¥¼ í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ì œê³µ
   
**[ì‚­ê° íŒë‹¨ ì§ˆë¬¸ì¸ ê²½ìš°]**
   - íŒë‹¨ ê²°ê³¼: "ì¸ì •ë¨", "ì‚­ê° ê°€ëŠ¥ì„± ìˆìŒ", "ì‚­ê°ë¨"
   - íŒë‹¨ ê·¼ê±°ì™€ ê´€ë ¨ ë²•ë ¹ ì œì‹œ
   - ì£¼ì˜ì‚¬í•­ ì•ˆë‚´

ë‹µë³€ ì›ì¹™:
1. ì œê³µëœ ê²€ìƒ‰ ê²°ê³¼(ì¸ì •ê¸°ì¤€, ì œì™¸ì‚¬í•­, ì‹¬ì‚¬ê¸°ì¤€)ë¥¼ ë°˜ë“œì‹œ ê¼¼ê¼¼íˆ ì½ê³  ë¶„ì„í•©ë‹ˆë‹¤.
2. ê° ë¬¸ì„œì—ì„œ ë°œê²¬í•œ êµ¬ì²´ì ì¸ ì˜ˆì‹œ, ê·œì •, ê¸°ì¤€ì„ ëª…í™•íˆ í™•ì¸í•©ë‹ˆë‹¤.
3. **ì§ˆë¬¸ì˜ í•µì‹¬ ì¡°ê±´ì„ ëª…í™•íˆ íŒŒì•…í•©ë‹ˆë‹¤**
4. **ìœ ì‚¬í•œ ì¼€ì´ìŠ¤ê°€ ì—¬ëŸ¬ ê°œ ìˆë‹¤ë©´ ë°˜ë“œì‹œ ë¹„êµí•˜ì—¬ ì§ˆë¬¸ì— ê°€ì¥ ì í•©í•œ ì¼€ì´ìŠ¤ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.**
5. ë¬¸ì„œ ë‚´ìš©ì´ ìƒì¶©ë˜ëŠ” ê²½ìš°, ê° ì¼€ì´ìŠ¤ì˜ ì¡°ê±´ ì°¨ì´ë¥¼ ëª…í™•íˆ ì„¤ëª…í•©ë‹ˆë‹¤.
6. ì§ˆë¬¸ì˜ ì˜ë„ë¥¼ ì •í™•íˆ íŒŒì•…í•˜ì—¬ ì ì ˆí•œ ë‹µë³€ í˜•ì‹(ìˆ˜ê°€ ì‚°ì • vs ì‚­ê° íŒë‹¨)ì„ ì„ íƒí•©ë‹ˆë‹¤.
7. êµ¬ì²´ì ì¸ ì½”ë“œ, ìˆ˜ê°€, ì‚°ì •ë°©ë²•ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
8. ì²­êµ¬ ì˜ˆì‹œëŠ” ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
9. ì¶”ì¸¡ì´ë‚˜ ê°€ì •ì´ ì•„ë‹Œ, ë¬¸ì„œì— ëª…ì‹œëœ ë‚´ìš©ë§Œì„ ê·¼ê±°ë¡œ ë‹µë³€í•©ë‹ˆë‹¤.

**ë…¼ë¦¬ì  ì¶”ë¡  ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!):**

1. **ìˆ«ì ë²”ìœ„ ë¹„êµ**: 
   - "X ì´ìƒ", "X ë¯¸ë§Œ", "X ì´ˆê³¼", "X ì´í•˜" ë“±ì˜ ì¡°ê±´ì€ ìˆ˜í•™ì  ë¶€ë“±ì‹ìœ¼ë¡œ ì •í™•íˆ íŒë‹¨
   - ì§ˆë¬¸ì˜ ìˆ˜ì¹˜ê°€ ë¬¸ì„œì˜ ë²”ìœ„ ì¡°ê±´ì— í¬í•¨ë˜ëŠ”ì§€ ë…¼ë¦¬ì ìœ¼ë¡œ ë¹„êµ
   
2. **ì¡°ê±´ì˜ êµ¬ì²´ì„±ê³¼ í¬í•¨ ê´€ê³„**: 
   - ë¬¸ì„œì˜ ì¡°ê±´ì´ íŠ¹ì • ìœ„ì¹˜/ìœ í˜•ì„ ëª…ì‹œí•œ ê²½ìš°, í•´ë‹¹ ì¡°ê±´ë§Œ ì¸ì •
   - ì§ˆë¬¸ì—ì„œ ëª…ì‹œë˜ì§€ ì•Šì€ ì¡°ê±´ì´ ìˆë‹¤ë©´, ì´ë¥¼ ëª…í™•íˆ ì§€ì í•˜ê³  í™•ì¸ í•„ìš”ì„± ì–¸ê¸‰
   - "A ë˜ëŠ” B ë˜ëŠ” C" í˜•íƒœëŠ” OR ì¡°ê±´ (í•˜ë‚˜ë§Œ ì¶©ì¡±í•˜ë©´ ë¨)
   
3. **ì¡°ê±´ì˜ ë…¼ë¦¬ì  ê²°í•©**:
   - "Aì´ë©´ì„œ B" = AND ì¡°ê±´ (ëª¨ë‘ ì¶©ì¡± í•„ìš”)
   - "A ë˜ëŠ” B" = OR ì¡°ê±´ (í•˜ë‚˜ë§Œ ì¶©ì¡±í•˜ë©´ ë¨)
   - "Aì´ì§€ë§Œ Bê°€ ì•„ë‹Œ" = AND NOT ì¡°ê±´ (A ì¶©ì¡±, B ì œì™¸)
   - ì—¬ëŸ¬ ì¡°ê±´ì´ ë‚˜ì—´ëœ ê²½ìš°, ë¬¸ë§¥ìƒ ANDì¸ì§€ ORì¸ì§€ íŒë‹¨
   
4. **ëª…ì‹œì  ê¸°ì¤€ vs ì˜ˆì™¸ ì¡°í•­**:
   - ì›ì¹™ì  ì œì™¸ ì¡°ê±´ì´ë¼ë„ "ë‹¨, ~í•œ ê²½ìš° ì¸ì •" ë“±ì˜ ì˜ˆì™¸ê°€ ìˆìœ¼ë©´ ìš°ì„  ì ìš©
   - "ì˜ì‚¬ì†Œê²¬ì„œ ì²¨ë¶€ ì‹œ", "íŠ¹ì • ê²€ì‚¬ ê²°ê³¼ í™•ì¸ ì‹œ" ë“±ì˜ ì¡°ê±´ë¶€ ì¸ì • í™•ì¸
   
5. **ì²´ê³„ì  ì¡°ê±´ ë§¤ì¹­ í”„ë¡œì„¸ìŠ¤**:
   â‘  ì§ˆë¬¸ì—ì„œ ëª…ì‹œëœ ëª¨ë“  ì¡°ê±´ ì¶”ì¶œ (ìˆ˜ì¹˜, ìœ„ì¹˜, ìœ í˜•, ìƒí™© ë“±)
   â‘¡ ê° ë¬¸ì„œ ì¼€ì´ìŠ¤ì˜ ì¸ì • ì¡°ê±´ì„ ëª…í™•íˆ íŒŒì•…
   â‘¢ ì§ˆë¬¸ì˜ ê° ì¡°ê±´ì´ ë¬¸ì„œ ì¼€ì´ìŠ¤ì˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ”ì§€ í•˜ë‚˜ì”© ê²€ì¦
   â‘£ ëª¨ë“  ì¡°ê±´ì´ ì™„ì „íˆ ì¼ì¹˜í•˜ëŠ” ì¼€ì´ìŠ¤ë¥¼ ìš°ì„  ì„ íƒ
   â‘¤ ì™„ì „ ì¼ì¹˜ê°€ ì—†ìœ¼ë©´, ë¶€ë¶„ ì¼ì¹˜ ì¼€ì´ìŠ¤ì™€ ë¶ˆì¼ì¹˜ ì¡°ê±´ì„ ëª…ì‹œ

ë‹µë³€ í˜•ì‹ (ë°˜ë“œì‹œ ì´ ìˆœì„œë¡œ ì‘ì„±):

**ğŸ“‹ ë¬¸ì„œ ë¶„ì„**:

**ì§ˆë¬¸ì˜ í•µì‹¬ ì¡°ê±´**:
- [ì§ˆë¬¸ì—ì„œ ëª…ì‹œëœ ì¤‘ìš”í•œ ì¡°ê±´ë“¤ì„ ë¨¼ì € ì •ë¦¬. ì˜ˆ: "LADì™€ LM ëª¨ë‘ ë³‘ë³€ ìˆìŒ", "ìŠ¤í…íŠ¸ 1ê°œ", "cross-over ë°©ì‹"]

**ë¬¸ì„œì—ì„œ ë°œê²¬í•œ ê´€ë ¨ ì¼€ì´ìŠ¤**:
- ì¼€ì´ìŠ¤ 1: [ì¡°ê±´ ë° ìˆ˜ê°€ ì‚°ì • ë°©ë²•]
- ì¼€ì´ìŠ¤ 2: [ì¡°ê±´ ë° ìˆ˜ê°€ ì‚°ì • ë°©ë²•]
- ì¼€ì´ìŠ¤ 3: [ì¡°ê±´ ë° ìˆ˜ê°€ ì‚°ì • ë°©ë²•]

**ì¼€ì´ìŠ¤ ë¹„êµ ë° ì„ íƒ**:
- [ê° ì¼€ì´ìŠ¤ì˜ ì¡°ê±´ì„ ì§ˆë¬¸ì˜ ì¡°ê±´ê³¼ í•˜ë‚˜ì”© ì²´ê³„ì ìœ¼ë¡œ ëŒ€ì¡°]
- [ìˆ«ì ì¡°ê±´: ìˆ˜í•™ì  ë¶€ë“±ì‹ì„ ì‚¬ìš©í•˜ì—¬ ë²”ìœ„ í¬í•¨ ì—¬ë¶€ íŒë‹¨]
- [ìœ„ì¹˜/ìœ í˜• ì¡°ê±´: ì§ˆë¬¸ì˜ ëª…ì‹œì„±ê³¼ ë¬¸ì„œì˜ êµ¬ì²´ì„± ë¹„êµ]
- [ë…¼ë¦¬ ì—°ì‚°ì(AND/OR) í™•ì¸í•˜ì—¬ ì¡°ê±´ ì¶©ì¡± ì—¬ë¶€ íŒë‹¨]
- [ì§ˆë¬¸ì˜ ëª¨ë“  ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¼€ì´ìŠ¤ ì„ íƒ ë° ëª…í™•í•œ ì´ìœ  ì œì‹œ]
- [ì™„ì „ ì¼ì¹˜ ì¼€ì´ìŠ¤ê°€ ì—†ë‹¤ë©´, ê°€ì¥ ìœ ì‚¬í•œ ì¼€ì´ìŠ¤ì™€ êµ¬ì²´ì ì¸ ì°¨ì´ì  ëª…ì‹œ]

**ì ìš© ê·œì •**: [ê´€ë ¨ ê³ ì‹œ, ë²•ë ¹, ì¸ì •ê¸°ì¤€ ë²ˆí˜¸]

---

[ìˆ˜ê°€ ì‚°ì • ì§ˆë¬¸ì¸ ê²½ìš°]
**ìˆ˜ê°€ ì‚°ì • ë°©ë²•**:

1. **ì£¼ ì‹œìˆ  (ì²« ë²ˆì§¸ í˜ˆê´€)**: 
   - ì½”ë“œ: [ì½”ë“œëª…]
   - ë‚´ì—­: [ìƒì„¸ ë‚´ì—­]

2. **ì¶”ê°€ ì‹œìˆ  (ë‘ ë²ˆì§¸ í˜ˆê´€)**: 
   - ì½”ë“œ: [ì½”ë“œëª…]
   - ë‚´ì—­: [ìƒì„¸ ë‚´ì—­]

3. **ì¬ë£ŒëŒ€**: 
   - [ì¬ë£Œ ì‚°ì • ë°©ë²•]

**ì²­êµ¬ ì˜ˆì‹œ**:

| ì½”ë“œ | ì¤„ë²ˆí˜¸ | í•­ëª© | ì¼íˆ¬ | ì´íˆ¬ | ë‚´ì—­ |
|------|--------|------|------|------|------|
| [ì½”ë“œ] | 0001 | 08 | 1 | 1 | [ì‹œìˆ ëª…] |
| [ì½”ë“œ] | 0002 | 08 | 1 | 1 | [ì‹œìˆ ëª…] |

**ì°¸ê³ ì‚¬í•­**:
- [ì¶”ê°€ ì„¤ëª…]

[ì‚­ê° íŒë‹¨ ì§ˆë¬¸ì¸ ê²½ìš°]
**íŒë‹¨**: [ì¸ì •ë¨/ì¡°ê±´ë¶€ ì¸ì •/ì‚­ê° ê°€ëŠ¥ì„± ìˆìŒ/ì‚­ê°ë¨]

**ê·¼ê±°**:
- [êµ¬ì²´ì ì¸ ì¸ì •ê¸°ì¤€ì´ë‚˜ ì œì™¸ì‚¬í•­ì„ ëª…í™•íˆ ì œì‹œ]
- [ì§ˆë¬¸ì˜ ê° ì¡°ê±´ì´ ê¸°ì¤€ì„ ì¶©ì¡±í•˜ëŠ”ì§€ í•˜ë‚˜ì”© ê²€ì¦]
- [ìˆ«ì ì¡°ê±´: ìˆ˜í•™ì  ë¶€ë“±ì‹ìœ¼ë¡œ ë²”ìœ„ í¬í•¨ ì—¬ë¶€ ëª…í™•íˆ ì„¤ëª…]
- [ìœ„ì¹˜/ìœ í˜• ì¡°ê±´: ì§ˆë¬¸ì—ì„œ ëª…ì‹œë˜ì§€ ì•Šì€ ì¡°ê±´ì´ ìˆë‹¤ë©´ í™•ì¸ í•„ìš”ì„± ì§€ì ]

**ê´€ë ¨ ë²•ë ¹**:
- [ê³ ì‹œëª… ë° ì¡°í•­]

**ì°¸ê³ ì‚¬í•­**:
- [ì¶”ê°€ë¡œ ê³ ë ¤í•´ì•¼ í•  ì‚¬í•­]
- [ë¶ˆëª…í™•í•œ ì¡°ê±´ì´ ìˆëŠ” ê²½ìš°, ì–´ë–¤ ì •ë³´ê°€ ì¶”ê°€ë¡œ í•„ìš”í•œì§€ ëª…ì‹œ]
"""
    
    def invoke_claude(
        self,
        user_message: str,
        context: str = "",
        conversation_history: List[Dict[str, str]] = None,
        max_tokens: int = 4000
    ) -> str:
        """
        Claude 4.5 Sonnet ëª¨ë¸ í˜¸ì¶œ (ìµœì‹  ëª¨ë¸, ë›°ì–´ë‚œ ì¶”ë¡  ëŠ¥ë ¥)
        
        Args:
            user_message: ì‚¬ìš©ì ì§ˆë¬¸
            context: ê²€ìƒ‰ëœ ì»¨í…ìŠ¤íŠ¸ (ê´€ë ¨ ë¬¸ì„œ)
            conversation_history: ì´ì „ ëŒ€í™” ë‚´ì—­ [{"role": "user/assistant", "content": "..."}]
            max_tokens: ìµœëŒ€ í† í° ìˆ˜ (ê¸°ë³¸ 4000)
            
        Returns:
            ëª¨ë¸ ì‘ë‹µ
        """
        try:
            # ì»¨í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ ì¶”ê°€
            if context:
                full_message = f"""ë‹¤ìŒì€ ê²€ìƒ‰ëœ ê´€ë ¨ ì •ë³´ì…ë‹ˆë‹¤:

{context}

---

ì§ˆë¬¸: {user_message}

ìœ„ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë°˜ë“œì‹œ ë‹¤ìŒ ìˆœì„œë¡œ ì²˜ë¦¬í•´ì£¼ì„¸ìš”:
1. **ì§ˆë¬¸ ë¶„ì„**: ì§ˆë¬¸ì—ì„œ ëª…ì‹œëœ ëª¨ë“  í•µì‹¬ ì¡°ê±´ì„ ì •í™•íˆ ì¶”ì¶œí•˜ì„¸ìš” (ìˆ˜ì¹˜, ìœ„ì¹˜, ìœ í˜•, ìƒí™© ë“±).
2. **ë¬¸ì„œ ë¶„ì„**: ê° ë¬¸ì„œë¥¼ ê¼¼ê¼¼íˆ ì½ê³  í•µì‹¬ ê·œì •, ì˜ˆì‹œ, ì¸ì •ê¸°ì¤€ì„ íŒŒì•…í•˜ì„¸ìš”.
3. **ì¼€ì´ìŠ¤ ë¹„êµ (ë§¤ìš° ì¤‘ìš”!)**: 
   - ê° ì¼€ì´ìŠ¤ì˜ ì¡°ê±´ì„ ì§ˆë¬¸ì˜ ì¡°ê±´ê³¼ í•˜ë‚˜ì”© ì²´ê³„ì ìœ¼ë¡œ ëŒ€ì¡°
   - ìˆ«ì ì¡°ê±´ì€ ìˆ˜í•™ì  ë¶€ë“±ì‹ìœ¼ë¡œ ë²”ìœ„ í¬í•¨ ì—¬ë¶€ íŒë‹¨
   - ìœ„ì¹˜/ìœ í˜• ì¡°ê±´ì€ ì§ˆë¬¸ì˜ ëª…ì‹œì„±ê³¼ ë¬¸ì„œì˜ êµ¬ì²´ì„± ë¹„êµ
   - ë…¼ë¦¬ ì—°ì‚°ì(AND/OR)ë¥¼ ì •í™•íˆ íŒŒì•…í•˜ì—¬ ì¡°ê±´ ì¶©ì¡± ì—¬ë¶€ íŒë‹¨
4. **ë‹µë³€ ìœ í˜• ì„ íƒ**: ìˆ˜ê°€ ì‚°ì • ì§ˆë¬¸ì¸ì§€, ì‚­ê° íŒë‹¨ ì§ˆë¬¸ì¸ì§€ ëª…í™•íˆ êµ¬ë¶„í•˜ì„¸ìš”.
5. **ìµœì¢… ë‹µë³€**: ì„ íƒí•œ ì¼€ì´ìŠ¤ì™€ ë…¼ë¦¬ì  ê·¼ê±°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•œ ë‹µë³€ì„ ì œì‹œí•˜ì„¸ìš”.
6. ë°˜ë“œì‹œ "ğŸ“‹ ë¬¸ì„œ ë¶„ì„" ì„¹ì…˜ë¶€í„° ì‹œì‘í•˜ì„¸ìš”."""
            else:
                full_message = user_message
            
            # ë©”ì‹œì§€ ë°°ì—´ êµ¬ì„±
            messages = []
            
            # ì´ì „ ëŒ€í™” ë‚´ì—­ì´ ìˆìœ¼ë©´ ì¶”ê°€
            if conversation_history:
                messages.extend(conversation_history)
            
            # í˜„ì¬ ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            messages.append({
                "role": "user",
                "content": full_message
            })
            
            # Claude API í˜¸ì¶œ (Bedrock)
            body = json.dumps({
                "anthropic_version": "bedrock-2023-05-31",
                "max_tokens": max_tokens,
                "system": self.system_prompt,
                "messages": messages,
                "temperature": 0.7,  # ë” ìœ ì—°í•œ ì¶”ë¡ ì„ ìœ„í•œ ì„¤ì •
                "top_p": 0.9
            })
            
            response = self.bedrock_runtime.invoke_model(
                modelId=self.model_id,
                body=body,
                contentType="application/json",
                accept="application/json"
            )
            
            # ì‘ë‹µ íŒŒì‹±
            response_body = json.loads(response["body"].read())
            answer = response_body.get("content", [{}])[0].get("text", "")
            
            return answer
            
        except Exception as e:
            error_msg = f"Claude í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"
            print(error_msg)
            return error_msg
    
    def answer_query(
        self,
        question: str,
        material_code: str = None,
        procedure_code: str = None,
        retrieved_docs: List[Dict[str, Any]] = None,
        conversation_history: List[Dict[str, str]] = None
    ) -> Dict[str, Any]:
        """
        ì§ˆì˜ì— ëŒ€í•œ ë‹µë³€ ìƒì„±
        
        Args:
            question: ì‚¬ìš©ì ì§ˆë¬¸
            material_code: ì¬ë£Œì½”ë“œ (ì„ íƒì‚¬í•­)
            procedure_code: ì‹œìˆ ì½”ë“œ (ì„ íƒì‚¬í•­)
            retrieved_docs: ê²€ìƒ‰ëœ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸
            conversation_history: ì´ì „ ëŒ€í™” ë‚´ì—­
            
        Returns:
            ë‹µë³€ ë”•ì…”ë„ˆë¦¬ (answer, sources, reasoning)
        """
        # ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
        context = ""
        sources = []
        
        if retrieved_docs:
            context = "ê²€ìƒ‰ëœ ê´€ë ¨ ë¬¸ì„œ:\n\n"
            for i, doc in enumerate(retrieved_docs, 1):
                # 'type' ë˜ëŠ” 'file_type' í•„ë“œ ì²˜ë¦¬
                doc_type = doc['metadata'].get('type') or doc['metadata'].get('file_type') or 'document'
                context += f"[ë¬¸ì„œ {i}] {doc_type}\n"
                context += f"{doc['text']}\n"
                context += "-" * 60 + "\n\n"
                
                # íŒŒì¼ëª… ì¶”ì¶œ (ì—¬ëŸ¬ ê°€ëŠ¥í•œ í•„ë“œ í™•ì¸)
                filename = (
                    doc['metadata'].get('source_file') or 
                    doc['metadata'].get('document_title') or 
                    doc['metadata'].get('filename') or 
                    'Unknown'
                )
                
                sources.append({
                    "type": doc_type,
                    "filename": filename,
                    "pdf_title": doc['metadata'].get('pdf_title'),
                    "ì¬ë£Œì½”ë“œ": doc['metadata'].get('ì¬ë£Œì½”ë“œ'),
                    "ì¬ë£Œëª…": doc['metadata'].get('ì¬ë£Œëª…'),
                    "ì‹œìˆ ì½”ë“œ": doc['metadata'].get('ì‹œìˆ ì½”ë“œ'),
                    "ì‹œìˆ ëª…": doc['metadata'].get('ì‹œìˆ ëª…'),
                    "score": doc.get('score', 0),
                    "text": doc['text']  # ì œì™¸ ê¸°ëŠ¥ì„ ìœ„í•œ í…ìŠ¤íŠ¸ í¬í•¨
                })
        
        # ì‚¬ìš©ì ì§ˆë¬¸ êµ¬ì„±
        user_question_parts = []
        if material_code:
            user_question_parts.append(f"ì¬ë£Œì½”ë“œ: {material_code}")
        if procedure_code:
            user_question_parts.append(f"ì‹œìˆ ì½”ë“œ: {procedure_code}")
        user_question_parts.append(f"\nì§ˆë¬¸: {question}")
        
        user_question = "\n".join(user_question_parts)
        
        # Claude í˜¸ì¶œ (ëŒ€í™” íˆìŠ¤í† ë¦¬ í¬í•¨)
        answer = self.invoke_claude(
            user_question, 
            context, 
            conversation_history=conversation_history
        )
        
        return {
            "answer": answer,
            "sources": sources,
            "material_code": material_code,
            "procedure_code": procedure_code,
            "question": question
        }


# ì „ì²´ íŒŒì´í”„ë¼ì¸ (ê²€ìƒ‰ + ë‹µë³€)
def answer_insurance_query(
    question: str,
    material_code: str = None,
    procedure_code: str = None,
    conversation_history: List[Dict[str, str]] = None,
    excluded_sources: List[str] = None
) -> Dict[str, Any]:
    """
    ë³´í—˜ ì¸ì •ê¸°ì¤€ ì§ˆì˜ ì „ì²´ íŒŒì´í”„ë¼ì¸
    
    Args:
        question: ì§ˆë¬¸
        material_code: ì¬ë£Œì½”ë“œ (ì„ íƒì‚¬í•­)
        procedure_code: ì‹œìˆ ì½”ë“œ (ì„ íƒì‚¬í•­)
        conversation_history: ì´ì „ ëŒ€í™” ë‚´ì—­ (ì„ íƒì‚¬í•­)
        excluded_sources: ì œì™¸í•  ë¬¸ì„œ í…ìŠ¤íŠ¸ ëª©ë¡ (ì„ íƒì‚¬í•­)
        
    Returns:
        ë‹µë³€ ê²°ê³¼
    """
    from tools.hybrid_retriever import HybridRetriever
    
    # 1. ê´€ë ¨ ë¬¸ì„œ ê²€ìƒ‰ (í•˜ì´ë¸Œë¦¬ë“œ: ë²¡í„° 70% + BM25 30%)
    # Rerankerë¡œ ê´€ë ¨ì„± ë†’ì€ ë¬¸ì„œë§Œ ì„ ë³„
    retriever = HybridRetriever(
        vector_weight=0.7,
        bm25_weight=0.3,
        use_rrf=False,
        use_reranker=True  # ê´€ë ¨ì„± ë†’ì€ ë¬¸ì„œë§Œ ì„ ë³„
    )
    
    if material_code or procedure_code:
        # ì½”ë“œê°€ ìˆìœ¼ë©´ í•„í„°ë§í•´ì„œ ê²€ìƒ‰
        retrieved_docs = retriever.search_by_codes(
            material_code=material_code,
            procedure_code=procedure_code,
            query=question,
            top_k=10  # ë§ì€ í›„ë³´ ê²€ìƒ‰ â†’ Rerankerê°€ ê´€ë ¨ì„± ë†’ì€ ë¬¸ì„œë§Œ ì„ ë³„
        )
    else:
        # ì½”ë“œê°€ ì—†ìœ¼ë©´ ì „ì²´ ê²€ìƒ‰
        retrieved_docs = retriever.search(
            query=question,
            top_k=10  # ë§ì€ í›„ë³´ ê²€ìƒ‰ â†’ Rerankerê°€ ê´€ë ¨ì„± ë†’ì€ ë¬¸ì„œë§Œ ì„ ë³„
        )
    
    # ì œì™¸í•  ë¬¸ì„œ í•„í„°ë§ (ì‚¬ìš©ìê°€ ë…¸ì´ì¦ˆë¡œ ì§€ì •í•œ ë¬¸ì„œ ì œê±°)
    if excluded_sources and retrieved_docs:
        original_count = len(retrieved_docs)
        retrieved_docs = [
            doc for doc in retrieved_docs 
            if doc.get('text') not in excluded_sources
        ]
        filtered_count = original_count - len(retrieved_docs)
        if filtered_count > 0:
            print(f"[í•„í„°ë§] {filtered_count}ê°œ ë…¸ì´ì¦ˆ ë¬¸ì„œ ì œì™¸")
    
    # 2. ì—ì´ì „íŠ¸ë¡œ ë‹µë³€ ìƒì„± (ëŒ€í™” íˆìŠ¤í† ë¦¬ í¬í•¨)
    agent = InsuranceAnswerAgent()
    result = agent.answer_query(
        question=question,
        material_code=material_code,
        procedure_code=procedure_code,
        retrieved_docs=retrieved_docs if isinstance(retrieved_docs, list) else [],
        conversation_history=conversation_history
    )
    
    return result


# í…ŒìŠ¤íŠ¸ìš© ë©”ì¸ í•¨ìˆ˜
if __name__ == "__main__":
    print("=" * 60)
    print("ë³´í—˜ ì¸ì •ê¸°ì¤€ ë‹µë³€ ì—ì´ì „íŠ¸ í…ŒìŠ¤íŠ¸")
    print("=" * 60)
    
    # í…ŒìŠ¤íŠ¸ ì§ˆì˜
    result = answer_insurance_query(
        material_code="A12345",
        procedure_code="N2095",
        question="55ì„¸ í™˜ìê°€ í‡´í–‰ì„± ê³ ê´€ì ˆì—¼ìœ¼ë¡œ ê³ ê´€ì ˆ ì „ì¹˜í™˜ìˆ ì„ ë°›ëŠ” ê²½ìš° ì‚­ê°ë ê¹Œìš”?"
    )
    
    print("\nì§ˆë¬¸:", result['question'])
    print("\në‹µë³€:")
    print(result['answer'])
    print("\nì°¸ê³  ë¬¸ì„œ:", len(result['sources']), "ê°œ")
    for i, source in enumerate(result['sources'], 1):
        print(f"  [{i}] {source['type']} - {source['ì¬ë£Œëª…']}")


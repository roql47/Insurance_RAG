# 📊 PDF 테이블 추출 및 메타데이터 구조화 가이드

## 🎯 개요

PDF 문서에서 '제목'과 '질의' 컬럼이 있는 테이블을 자동으로 감지하고, 각 행을 개별 청크로 변환하여 메타데이터에 구조화합니다.

## ✨ 주요 기능

### 1. 자동 테이블 감지
- PDF의 모든 페이지에서 테이블을 자동 추출
- '제목'과 '질의' 컬럼이 있는 테이블만 선별적으로 처리
- 헤더 행을 자동으로 인식하여 컬럼 매핑

### 2. 개별 청크 생성
- **각 테이블 행이 하나의 독립적인 청크가 됩니다**
- 행마다 고유한 ID와 메타데이터 할당
- 일반 PDF 텍스트 청크와 함께 저장

### 3. 구조화된 메타데이터
각 테이블 청크에는 다음 정보가 포함됩니다:
- `table_title`: 제목 컬럼 값
- `table_query`: 질의 컬럼 값
- `page_number`: 페이지 번호
- `table_index`: 페이지 내 테이블 인덱스
- `row_index`: 테이블 내 행 인덱스
- `source_type`: "table" (테이블 출처 표시)
- `full_row_data`: 모든 컬럼 데이터

## 📝 테이블 형식 요구사항

PDF의 테이블은 다음 형식을 따라야 합니다:

```
┌──────┬──────┬────────┬────────┐
│ 제목 │ 질의 │ 기타1  │ 기타2  │
├──────┼──────┼────────┼────────┤
│ 값1  │ 값2  │ 값3    │ 값4    │
│ 값5  │ 값6  │ 값7    │ 값8    │
└──────┴──────┴────────┴────────┘
```

**필수 조건:**
- 첫 번째 행이 헤더여야 함
- '제목'과 '질의' 컬럼이 **모두** 있어야 함
- 컬럼 이름에 '제목', '질의'가 포함되면 인식됨 (예: "제목명", "질의사항" 등)

## 🚀 사용 방법

### 1. 테이블 추출 테스트

```cmd
cd backend
python test_table_extraction.py data/raw/your_file.pdf
```

**출력 예시:**
```
============================================================
테이블 추출 기능 테스트
============================================================

1. PDF 로드 중: data/raw/test.pdf
총 페이지 수: 5

테이블 데이터 추출 중...
  [페이지 1] 1개 테이블 발견
    → 테이블 1: '제목'(열 0) 및 '질의'(열 1) 컬럼 감지
  [OK] 총 5개 구조화된 테이블 행 추출

2. 테이블 데이터 확인
   - 추출된 테이블 행 수: 5개

   [테이블 행 샘플]
   행 1:
     - 제목: 고관절 전치환술
     - 질의: 급여 인정 기준은?...
     - 페이지: 1
     - 전체 컬럼: ['제목', '질의', '답변', '근거']

3. 청크 생성 중...
  [SEMANTIC] 의미 단위 청킹 사용 (목표: 1500자, 오버랩: 200자)
  [OK] 12개 의미 단위 청크 생성 완료
  [TABLE] 테이블 청크 생성 중: 5개 행
  [OK] 5개 테이블 청크 생성 완료
  [TOTAL] 총 17개 청크 (의미 단위: 12, 테이블: 5)

4. 청크 분석
   - 총 청크 수: 17개
   - PDF 청크: 12개
   - 테이블 청크: 5개

[결과 요약]
  - 테이블 행: 5개
  - 총 청크: 17개
    ├─ PDF: 12개
    └─ 테이블: 5개
```

### 2. 실제 학습에 사용

#### 배치 학습 (전체 파일)

```cmd
cd backend\src
python pipeline_pdf_batch.py ../data/raw
```

#### 증분 학습 (새 파일만)

```cmd
cd backend
python run_incremental_learning.py data/raw
```

## 📦 생성되는 청크 구조

### 일반 PDF 청크
```json
{
  "chunk_id": 0,
  "text": "문서 본문 내용...",
  "metadata": {
    "filename": "test.pdf",
    "source_type": "pdf",
    "section_title": "[페이지 1]",
    "chunk_index": 0
  }
}
```

### 테이블 청크
```json
{
  "chunk_id": 12,
  "text": "[제목] 고관절 전치환술\n\n[질의] 급여 인정 기준은?\n\n[답변] 퇴행성 관절염이...",
  "metadata": {
    "filename": "test.pdf",
    "source_type": "table",
    "table_title": "고관절 전치환술",
    "table_query": "급여 인정 기준은?",
    "page_number": 1,
    "table_index": 0,
    "row_index": 1,
    "chunk_index": 12
  }
}
```

## 🔍 검색 시 활용

테이블 메타데이터를 활용하여 더 정확한 검색이 가능합니다:

```python
# 검색 결과에서 테이블 청크 확인
for result in search_results:
    metadata = result['metadata']
    
    if metadata.get('source_type') == 'table':
        # 테이블 데이터
        print(f"제목: {metadata['table_title']}")
        print(f"질의: {metadata['table_query']}")
        print(f"페이지: {metadata['page_number']}")
    else:
        # 일반 PDF 텍스트
        print(f"섹션: {metadata.get('section_title', 'N/A')}")
```

## ⚙️ 설정 옵션

### document_loader.py의 `extract_tables_from_pdf` 함수

- 컬럼 이름 인식은 부분 일치를 사용 (`'제목' in header`)
- 다른 컬럼 이름도 추가 가능 (예: "제목명", "질의사항")

### 청크 생성 옵션

```python
chunks = loader.chunk_document(
    doc_data,
    chunk_size=1500,        # 일반 텍스트 청크 크기
    overlap=200,            # 오버랩 크기
    use_semantic_chunking=True  # 의미 단위 청킹
)
```

## 🎯 활용 사례

### 1. Q&A 데이터베이스
- 제목: 주제
- 질의: 질문
- 답변: 응답 (기타 컬럼)

### 2. 의료 보험 기준
- 제목: 시술명
- 질의: 급여 기준 질의
- 답변: 인정 기준 (기타 컬럼)

### 3. 법규 해석
- 제목: 법령 조항
- 질의: 해석 요청
- 답변: 법적 해석 (기타 컬럼)

## 🔧 문제 해결

### 테이블이 감지되지 않는 경우

1. **PDF 품질 확인**: 스캔 PDF가 아닌 텍스트 PDF여야 함
2. **테이블 형식 확인**: 명확한 테이블 구조가 있어야 함
3. **컬럼 이름 확인**: '제목'과 '질의' 문자열이 헤더에 포함되어야 함

### 잘못된 테이블이 추출되는 경우

- `document_loader.py`의 테이블 감지 로직 조정
- 컬럼 인식 조건 수정 (현재: 부분 일치)

## 📊 성능 최적화

- 테이블 청크는 일반 텍스트 청크보다 작음
- 각 테이블 행이 독립적이므로 검색 정확도 향상
- 메타데이터 필터링으로 빠른 조회 가능

## 🎉 완료!

이제 PDF의 테이블 데이터가 자동으로 구조화되어 검색 가능한 청크로 변환됩니다!

